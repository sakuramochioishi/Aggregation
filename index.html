<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>新ダンジョンポイント表</title>
  <style>
    :root{ --bg:#0f1720; --card:#0b1220; --muted:#94a3b8; --accent:#0ea5a2; --accent-2:#60a5fa }
    *{box-sizing:border-box}
    body{font-family: system-ui,-apple-system, "Hiragino Kaku Gothic ProN", "メイリオ", "Noto Sans JP", Arial; background:linear-gradient(180deg,#f8fafc,#eef2ff); padding:28px; color:#0f1720}
    .container{max-width:1100px;margin:0 auto}
    h1{font-size:1.4rem;margin-bottom:6px}
    p.lead{color:var(--muted);margin-top:0;margin-bottom:18px}
    .controls{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;align-items:center}
    .controls input[type="search"], .controls input[type="text"], .controls select{padding:8px 10px;border:1px solid #d1d5db;border-radius:8px}
    .btn{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    .btn.secondary{background:#64748b}
    .card{background:white;border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:collapse;min-width:640px}
    thead th{position:sticky;top:0;background:#f8fafc;padding:10px 12px;text-align:left;font-weight:700;border-bottom:2px solid #e6eef8;cursor:pointer}
    thead th .sort{font-size:12px;margin-left:8px;opacity:0.7}
    tbody td{padding:10px 12px;border-bottom:1px solid #eef2f7}
    tbody tr:nth-child(even){background:#ffffff}
    tbody tr:hover{background:#f1fbff}
    @media (max-width:640px){ thead{display:none} table, tbody, tr, td{display:block;width:100%} tr{margin-bottom:12px} td{padding-left:50%;position:relative} td::before{position:absolute;left:12px;top:12px;width:45%;white-space:nowrap;font-weight:700;color:#334155} td[data-label]::before{content:attr(data-label)} }
    .small{font-size:0.9rem;color:var(--muted)}
    .controls .count{margin-left:auto;color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <h1>Flyff ポイント表</h1>
    <p class="lead">キャラクター名と持ち点を追加・編集できます。持ち点は0以下のみ入力可能で、変更はAPI連携されます。</p>

    <div class="controls">
      <input id="search" type="search" placeholder="検索（名前・持ち点）..." />
      <button id="addRowBtn" class="btn secondary">行を追加</button>
      <div class="count small" id="count">0 件</div>
    </div>

    <div class="card">
      <div class="table-wrap">
        <table id="dataTable">
          <thead>
            <tr>
              <th data-key="id" style="display:none"></th>
              <th data-key="name">キャラクター名 <span class="sort">↕</span></th>
              <th data-key="note">持ち点 <span class="sort">↕</span></th>
              <th data-key="">操作 <span class="sort">↕</span></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <input id="fName" type="text" placeholder="キャラクター名" />
      <input id="fNote" type="number" placeholder="持ち点" max="0" />
      <button id="insertBtn" class="btn">追加</button>
    </div>
  </div>
<script>
let playerID = localStorage.getItem('playerID');
if(!playerID){
  playerID = 'player_' + Math.random().toString(36).substring(2,10);
  localStorage.setItem('playerID', playerID);
  createAccount();
}

async function createAccount(name='player'){
  const form = new URLSearchParams();
  form.append('action','account_create');
  form.append('ID', playerID);
  form.append('name', name);

  const res = await fetch('https://script.google.com/macros/s/AKfycbwk3sShprPJEkht2Osizha-BIzouXTwCfYX-g2HQK97O-cBoo7_Eyd5jgC4ha-JD2M/exec',{method:'POST', body: form});
  const data = await res.json();
  if(data.result==='already_exists'){
    playerID = 'player_' + Math.random().toString(36).substring(2,10);
    localStorage.setItem('playerID', playerID);
    await createAccount(name);
  }
}

async function updatePoints(id, value){
  if(value>0) value=0;
  const form = new URLSearchParams();
  form.append('action','points_edit');
  form.append('ID', id);
  form.append('points', value);
  const res = await fetch('https://script.google.com/macros/s/AKfycbwk3sShprPJEkht2Osizha-BIzouXTwCfYX-g2HQK97O-cBoo7_Eyd5jgC4ha-JD2M/exec',{method:'POST', body: form});
  const data = await res.json();
  return data.result;
}

async function updateName(id, newname){
  const form = new URLSearchParams();
  form.append('action','name_edit');
  form.append('ID', id);
  form.append('newname', newname);
  const res = await fetch('https://script.google.com/macros/s/AKfycbwk3sShprPJEkht2Osizha-BIzouXTwCfYX-g2HQK97O-cBoo7_Eyd5jgC4ha-JD2M/exec',{method:'POST', body: form});
  const data = await res.json();
  return data.result;
}

async function getDatas(){
  const res = await fetch('https://script.google.com/macros/s/AKfycbwk3sShprPJEkht2Osizha-BIzouXTwCfYX-g2HQK97O-cBoo7_Eyd5jgC4ha-JD2M/exec?action=get_datas');
  return await res.json(); // {ID: {name:"", point:..., log:...}}
}

const data = [];
let currentData = [...data];
let currentSort = { key:null, dir:1 };

const tbody = document.querySelector('#dataTable tbody');
const searchInput = document.querySelector('#search');
const countEl = document.querySelector('#count');

function renderTable(rows){
  tbody.innerHTML='';
  for(const r of rows){
    const tr = document.createElement('tr');
    tr.innerHTML=`
      <td data-label="ID" style="display:none">${r.id}</td>
      <td data-label="キャラクター名">${r.name}</td>
      <td data-label="持ち点">
        <input type="number" value="${r.note}" data-id="${r.id}" class="noteInput" max="0">
      </td>
      <td data-label="操作">
        <button class="updateBtn" data-id="${r.id}" data-name="${r.name}">更新</button>
      </td>
    `;
    tbody.appendChild(tr);
  }

  // inputの変更イベント（従来通り）
  document.querySelectorAll('.noteInput').forEach(input=>{
    input.addEventListener('change', e=>{
      let value = Number(e.target.value);
      if(value>0) value=0;
      e.target.value = value;
      const obj = data.find(d=>d.id==e.target.dataset.id);
      if(obj) obj.note=value;
    });
  });

// 更新ボタンのクリックイベント
document.querySelectorAll('.updateBtn').forEach(btn=>{
  btn.addEventListener('click', async e=>{
    const button = e.target;
    button.disabled = true;
    const originalText = button.textContent;
    button.textContent = "更新中...";

    const id = button.dataset.id;
    const name = button.dataset.name;
    const input = tbody.querySelector(`input.noteInput[data-id="${id}"]`);
    let value = Number(input.value);
    if(value > 0) value = 0;
    input.value = value;

    const res = await updatePoints(id, value);
    if(res === "success"){
      alert(`ID:${name} の持ち点を ${value} に更新しました`);
      const obj = data.find(d=>d.id==id);
      if(obj) obj.note = value;
    }else{
      alert(`ID:${name} の更新に失敗しました`);
    }

    // ボタンを元に戻す
    button.disabled = false;
    button.textContent = originalText;
  });
});


  countEl.textContent=`${rows.length} 件`;
}

function applyFilters(){
  const q = searchInput.value.trim().toLowerCase();
  let out = data.filter(d=>!q || d.name.toLowerCase().includes(q) || String(d.note).includes(q));
  if(currentSort.key){
    out.sort((a,b)=>{
      const A=a[currentSort.key], B=b[currentSort.key];
      if(!isNaN(A)&&!isNaN(B)) return (A-B)*currentSort.dir;
      return String(A).localeCompare(String(B))*currentSort.dir;
    });
  }
  currentData = out;
  renderTable(out);
}

document.querySelectorAll('thead th').forEach(th=>{
  th.addEventListener('click', ()=>{
    const key=th.getAttribute('data-key');
    if(currentSort.key===key) currentSort.dir=-currentSort.dir; else {currentSort.key=key; currentSort.dir=1;}
    applyFilters();
  });
});

searchInput.addEventListener('input', applyFilters);

// 初回ロード時にデータ取得してテーブル反映＆フォーム初期値設定
// 初回ロード時にデータ取得してテーブル反映＆フォーム初期値設定
(async ()=>{
  const datas = await getDatas(); // {ID: {name:"", point:..., log:...}}

  // data配列を初期化してAPI仕様に沿って構築
  data.length = 0;
  for(const [id,obj] of Object.entries(datas)){
    data.push({
      id: id,          // IDキー
      name: obj.name,  // 名前
      note: obj.point, // 持ち点
      log: obj.log     // ログ（必要なら表示用に保持）
    });
  }

  // テーブル描画
  applyFilters();

  // localStorageのplayerIDに対応するデータをフォーム初期値に設定
  if(datas[playerID]){
    document.querySelector('#fName').value = datas[playerID].name;
    document.querySelector('#fNote').value = datas[playerID].point;
  }
})();


// 追加ボタン修正版
document.querySelector('#insertBtn').addEventListener('click', async ()=>{
  const insertBtn = document.querySelector('#insertBtn');
  insertBtn.disabled = true;
  const originalText = insertBtn.textContent;
  insertBtn.textContent = "更新中...";

  const name = document.querySelector('#fName').value.trim();
  let note = document.querySelector('#fNote').value.trim();
  note = note ? Number(note) : 0;
  if(note > 0) note = 0;

  let success = true;

  // 名前変更チェック
  if(name){
    const res = await updateName(playerID, name);
    if(res !== "success") success = false;
  }

  // 持ち点変更チェック
  const resPoints = await updatePoints(playerID, note);
  if(resPoints !== "success") success = false;

  if(success){
    alert("更新が成功しました");
    // 成功後に最新データを取得してテーブル更新
    const datas = await getDatas();
    data.length = 0;
    for(const [id,obj] of Object.entries(datas)){
      data.push({id: id, name: obj.name, note: obj.point});
    }
    applyFilters();
  }else{
    alert("更新に失敗しました");
  }

  // #fNote を空に
  document.querySelector('#fNote').value = '';

  // ボタンを元に戻す
  insertBtn.disabled = false;
  insertBtn.textContent = originalText;
});

applyFilters();
document.querySelector('#addRowBtn').addEventListener('click', ()=> document.querySelector('#fName').focus());

  </script>
</body>
</html>